<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skills Assessment Platform</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="no-copy" oncontextmenu="return false" onselectstart="return false" ondragstart="return false">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="/">
                    <img src="/Assets/Screenshot 2025-08-01 092513.png" alt="SMARRTIFAI" class="logo">
                </a>
            </div>
            <div class="nav-steps">
                <div class="step" id="step-1"><span>1</span> Start</div>
                <div class="step" id="step-2"><span>2</span> Assess</div>
                <div class="step" id="step-3"><span>3</span> Results</div>
                <div class="step" id="step-4"><span>4</span> Roadmap</div>
                <div class="step" id="step-5"><span>5</span> Payment</div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Onboarding Section -->
        <div id="onboarding-section" class="onboarding-section">
            <div class="onboarding-content">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message bot-message">
                            <div class="message-content">
                                <span class="bot-avatar">ðŸ¤–</span>
                                <p>Hi! ðŸ‘‹ I'm here to help you start your tech journey. What's your current situation?</p>
                            </div>
                        </div>
                    </div>
                    <div class="chat-options" id="chatOptions">
                        <button class="option-btn" onclick="handleOnboardingResponse(0, 'I\'m new to tech')">I'm new to tech</button>
                        <button class="option-btn" onclick="handleOnboardingResponse(0, 'I have some basic knowledge about tech')">I have some basic knowledge about tech</button>
                        <button class="option-btn" onclick="handleOnboardingResponse(0, 'I\'m looking to switch career')">I'm looking to switch career</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Mentor Section -->
        <div id="mentor-section" class="mentor-section hidden">
            <div class="mentor-container">
                <h3>ðŸ’¬ Ask Your AI Career Mentor</h3>
                <div class="mentor-chat">
                    <input type="text" id="mentorInput" placeholder="Ask about career paths, learning strategies, or job hunting..." onkeypress="if(event.key==='Enter') askMentor()" />
                    <button onclick="askMentor()">Ask</button>
                </div>
                <div class="mentor-response" id="mentorResponse"></div>
            </div>
        </div>

        <!-- Hero Section -->
        <div class="hero-section hidden">
            <div class="hero-content">
                <h1><i class="fas fa-rocket"></i> Transform Your Career Journey</h1>
                <p>AI-powered skills assessment with personalized career roadmaps</p>
                <div class="hero-stats">
                    <div class="stat"><span class="stat-number">10K+</span><span class="stat-label">Assessments</span></div>
                    <div class="stat"><span class="stat-number">95%</span><span class="stat-label">Accuracy</span></div>
                    <div class="stat"><span class="stat-number">5</span><span class="stat-label">Tech Fields</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Universal Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-links">
                <a href="https://smarrtifai.com/privacy-policy/" target="_blank" class="footer-link">
                    <i class="fas fa-shield-alt"></i> Privacy Policy
                </a>
                <div class="footer-divider"></div>
                <a href="https://smarrtifai.com/terms-of-use/" target="_blank" class="footer-link">
                    <i class="fas fa-file-contract"></i> Terms of Use
                </a>
                <div class="footer-divider"></div>
                <a href="https://smarrtifai.com/contact-us/" target="_blank" class="footer-link">
                    <i class="fas fa-envelope"></i> Contact Us
                </a>
            </div>
        </div>
    </footer>

    <script>
        let currentStep = 0;
        let selectedInterests = [];

        async function handleOnboardingResponse(step, response) {
            // Add user message (only for single select)
            if (step !== 1) {
                addMessage(response, 'user');
            }
            
            try {
                const apiResponse = await fetch('/api/onboarding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        step: step + 1, 
                        response: response
                    })
                });
                
                const data = await apiResponse.json();
                
                if (data.complete) {
                    if (data.redirect) {
                        // If redirecting to assessment, start interest-based assessment first
                        if (data.redirect === '/assessment') {
                            startInterestBasedAssessment();
                        } else {
                            window.location.href = data.redirect;
                        }
                    } else {
                        addMessage(data.message, 'bot');
                        showMentorSection();
                    }
                } else {
                    addMessage(data.question, 'bot');
                    showOptions(data.options, data.type, step + 1);
                }
            } catch (error) {
                console.error('Onboarding error:', error);
                addMessage('Sorry, there was an error. Please try again.', 'bot');
            }
        }

        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            if (sender === 'bot') {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <span class="bot-avatar">ðŸ¤–</span>
                        <div class="message-text">
                            <p>${text}</p>
                            <div class="typing-indicator" style="display: none;">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content user-content">
                        <p>${text}</p>
                        <span class="user-avatar">ðŸ‘¤</span>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Add typing effect for bot messages
            if (sender === 'bot') {
                const messageText = messageDiv.querySelector('p');
                const originalText = text;
                messageText.textContent = '';
                
                let i = 0;
                const typeWriter = () => {
                    if (i < originalText.length) {
                        messageText.textContent += originalText.charAt(i);
                        i++;
                        setTimeout(typeWriter, 30);
                    }
                };
                setTimeout(typeWriter, 300);
            }
        }

        function showOptions(options, type, step) {
            const optionsContainer = document.getElementById('chatOptions');
            
            if (type === 'multi') {
                const optionsHtml = options.map(option => 
                    `<span class="chip" onclick="toggleInterest('${option}')">${option}</span>`
                ).join('');
                optionsContainer.innerHTML = `
                    <div class="chip-container">${optionsHtml}</div>
                    <button class="btn-primary" onclick="proceedWithInterests(${step})" style="margin-top: 1rem;">Continue with Selected Interests</button>
                `;
            } else {
                const optionsHtml = options.map(option => 
                    `<button class="option-btn" onclick="handleOnboardingResponse(${step}, '${option}')">${option}</button>`
                ).join('');
                optionsContainer.innerHTML = optionsHtml;
            }
        }

        function toggleInterest(interest) {
            if (selectedInterests.includes(interest)) {
                selectedInterests = selectedInterests.filter(i => i !== interest);
            } else {
                selectedInterests.push(interest);
            }
            updateInterestButtons();
        }

        function updateInterestButtons() {
            document.querySelectorAll('.chip').forEach(chip => {
                if (selectedInterests.includes(chip.textContent)) {
                    chip.classList.add('active');
                } else {
                    chip.classList.remove('active');
                }
            });
        }

        function proceedWithInterests(step) {
            if (selectedInterests.length === 0) {
                alert('Please select at least one interest.');
                return;
            }
            
            // Add user message showing selected interests
            addMessage(`Selected: ${selectedInterests.join(', ')}`, 'user');
            
            // Proceed to next step (use correct step number)
            handleOnboardingResponse(step, selectedInterests.join(', '));
        }

        function showMentorSection() {
            document.getElementById('mentor-section').classList.remove('hidden');
            setTimeout(addQuickStartButton, 100);
        }

        async function askMentor() {
            const input = document.getElementById('mentorInput');
            const question = input.value.trim();
            
            if (!question) return;
            
            const responseDiv = document.getElementById('mentorResponse');
            responseDiv.innerHTML = '<div class="loading">Thinking...</div>';
            
            try {
                const response = await fetch('/api/mentor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });
                
                const data = await response.json();
                responseDiv.innerHTML = `<div class="mentor-answer">${data.response}</div>`;
                input.value = '';
            } catch (error) {
                responseDiv.innerHTML = '<div class="error">Sorry, I encountered an error. Please try again.</div>';
            }
        }

        async function startInterestBasedAssessment() {
            showCameraPermissionModal(() => proceedWithInterestAssessment());
        }

        async function proceedWithInterestAssessment() {
            try {
                const response = await fetch('/api/assessment/interest-based', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.redirect) {
                    window.location.href = data.redirect;
                } else if (data.error) {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Assessment start error:', error);
                alert('Error starting assessment. Please try again.');
            }
        }

        function showCameraPermissionModal(onAllow) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-icon">
                        <i class="fas fa-video" style="color: var(--primary); font-size: 3rem;"></i>
                    </div>
                    <h3>Camera Access Required</h3>
                    <p>This assessment requires camera monitoring for security and proctoring purposes. Your privacy is protected.</p>
                    <div class="modal-actions">
                        <button class="btn-primary" onclick="allowCameraAndProceed()">
                            <i class="fas fa-video"></i> Allow Camera & Continue
                        </button>
                        <button class="btn-secondary" onclick="cancelAssessment()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            window.allowCameraAndProceed = async () => {
                try {
                    await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                    modal.remove();
                    onAllow();
                } catch (error) {
                    alert('Camera access is required. Please allow camera permissions.');
                }
            };
            
            window.cancelAssessment = () => {
                modal.remove();
            };
        }

        // Add quick start button for interest-based assessment
        function addQuickStartButton() {
            const mentorSection = document.getElementById('mentor-section');
            if (mentorSection && !mentorSection.classList.contains('hidden')) {
                const quickStartHtml = `
                    <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.2);">
                        <button class="btn-primary" onclick="startInterestBasedAssessment()" style="background: rgba(255,255,255,0.2); border: 2px solid white;">
                            <i class="fas fa-play-circle"></i> Start Skills Assessment
                        </button>
                    </div>
                `;
                mentorSection.querySelector('.mentor-container').insertAdjacentHTML('beforeend', quickStartHtml);
            }
        }
    </script>
</body>
</html>